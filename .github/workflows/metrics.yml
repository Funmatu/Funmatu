name: Metrics
on:
  schedule:
    - cron: "30 1 * * *"
  workflow_dispatch:

jobs:
  github-metrics:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      # 1. ãƒªãƒã‚¸ãƒˆãƒªã‚’ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆï¼ˆç¾åœ¨ã®ç”»åƒã‚’å–å¾—ã™ã‚‹ãŸã‚å¿…é ˆï¼‰
      - name: ğŸ“‚ Checkout repository
        uses: actions/checkout@v4

      # 2. Metricsã®ç”Ÿæˆï¼ˆä¸€æ™‚ãƒ•ã‚¡ã‚¤ãƒ«ã«å‡ºåŠ›ã€è‡ªå‹•ã‚³ãƒŸãƒƒãƒˆã¯OFFï¼‰
      - name: ğŸ“Š Generate GitHub Metrics
        uses: Funmatu/metrics@master
        with:
          use_prebuilt_image: yes
          token: ${{ secrets.PERSONAL_ACCESS_TOKEN }}
          committer_token: ${{ secrets.GITHUB_TOKEN }}
          
          # ãƒ¦ãƒ¼ã‚¶ãƒ¼è¨­å®š
          user: Funmatu
          template: classic
          base: header, activity, community, repositories, metadata
          config_timezone: Asia/Tokyo
          
          # ã€é‡è¦ã€‘ãƒ•ã‚§ãƒ¼ãƒ«ã‚»ãƒ¼ãƒ•è¨­å®š 1: ä¸€æ™‚ãƒ•ã‚¡ã‚¤ãƒ«åã«å‡ºåŠ›ã—ã€ã“ã“ã§ã¯ã‚³ãƒŸãƒƒãƒˆã—ãªã„
          filename: github-metrics-temp.svg
          output_action: none 
          
          # ã€é‡è¦ã€‘ãƒ‡ãƒãƒƒã‚°ç”¨: ã‚¨ãƒ©ãƒ¼ãŒã‚ã‚Œã°ãƒ­ã‚°ã«å‡ºã—ã¦å‡¦ç†ã‚’æ­¢ã‚ã‚‹ï¼ˆæ¤œè¨¼ã‚¹ãƒ†ãƒƒãƒ—ã§æ‹¾ã†ãŸã‚ï¼‰
          plugins_errors_fatal: yes
          debug: yes

          # ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯/ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆå¯¾ç­–
          retries: 20
          retries_delay: 600
          repositories: 200
          repositories_batch: 85

          # Languagesè¨­å®š
          plugin_languages: yes
          plugin_languages_ignored: D
          plugin_languages_indepth: yes
          plugin_languages_details: lines, percentage, bytes-size
          plugin_languages_sections: most-used
          plugin_languages_categories: programming
          plugin_languages_limit: 8
          plugin_languages_analysis_timeout: 1200
          plugin_languages_analysis_timeout_repositories: 600

          # Habitsè¨­å®š
          plugin_habits: yes
          plugin_habits_from: 365
          plugin_habits_days: 28
          plugin_habits_facts: no
          plugin_habits_charts: yes
          plugin_habits_trim: yes

          # Followupè¨­å®š
          plugin_followup: yes
          plugin_followup_sections: repositories

          # Achievementsè¨­å®š
          plugin_achievements: yes
          plugin_achievements_display: compact
          plugin_achievements_threshold: B
          plugin_achievements_ignored: projects

      # 3. ãƒ•ã‚§ãƒ¼ãƒ«ã‚»ãƒ¼ãƒ•è¨­å®š 2: ãƒ•ã‚¡ã‚¤ãƒ«ã®æ¤œè¨¼ã¨ç§»å‹•
      - name: ğŸ›¡ï¸ Verify output
        run: |
          # DockerãŒå‡ºåŠ›ã—ãŸçµ¶å¯¾ãƒ‘ã‚¹ã‚’æŒ‡å®šã—ã¾ã™
          SOURCE_FILE="/metrics_renders/github-metrics-temp.svg"
          TARGET_FILE="github-metrics.svg"

          echo "Verifying $SOURCE_FILE..."
          
          # 1. ãƒ•ã‚¡ã‚¤ãƒ«ãŒå­˜åœ¨ã™ã‚‹ã‹ç¢ºèªï¼ˆçµ¶å¯¾ãƒ‘ã‚¹ã§ï¼‰
          if [ ! -f "$SOURCE_FILE" ]; then
            echo "Error: File was not generated at $SOURCE_FILE"
            echo "Debug: Listing /metrics_renders content:"
            ls -la /metrics_renders/ || echo "Directory not found"
            exit 1
          fi

          # 2. ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚ºã‚’ç¢ºèª (sudo catã‚’ä½¿ç”¨)
          # DockerãŒrootæ¨©é™ã§ä½œæˆã™ã‚‹ãŸã‚ã€èª­ã¿è¾¼ã¿ã«sudoãŒå¿…è¦ãªå ´åˆãŒã‚ã‚‹ï¼Ÿ
          FILE_SIZE=$(sudo cat "$SOURCE_FILE" | wc -c)
          echo "Generated file size: $FILE_SIZE bytes"

          # é–¾å€¤è¨­å®š (60KB)
          MIN_SIZE=60000
          
          if [ "$FILE_SIZE" -lt "$MIN_SIZE" ]; then
            echo "Error: File size is too small ($FILE_SIZE bytes). Analysis might have failed."
            exit 1
          fi
          
          # 3. æ­£å¸¸ã§ã‚ã‚Œã°ã€ãƒ¯ãƒ¼ã‚¯ã‚¹ãƒšãƒ¼ã‚¹ï¼ˆç¾åœ¨ã®ãƒ•ã‚©ãƒ«ãƒ€ï¼‰ã«ç§»å‹•
          # ã“ã“ã§ã‚‚æ¨©é™ã‚¨ãƒ©ãƒ¼ã‚’é˜²ããŸã‚ sudo ã‚’ä½¿ã†
          sudo mv "$SOURCE_FILE" "./$TARGET_FILE"
          echo "Verification passed. File moved to workspace successfully."

      # 4. ãƒ•ã‚§ãƒ¼ãƒ«ã‚»ãƒ¼ãƒ•è¨­å®š 3: æ­£å¸¸ãªå ´åˆã®ã¿ã‚³ãƒŸãƒƒãƒˆ
      - name: ğŸš€ Commit and Push
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          
          # å¤‰æ›´ãŒã‚ã‚‹å ´åˆã®ã¿ã‚³ãƒŸãƒƒãƒˆ
          git add github-metrics.svg
          if git diff --cached --quiet; then
            echo "No changes to commit."
          else
            git commit -m "Update GitHub Metrics"
            git push
          fi
